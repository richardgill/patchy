pre-commit:
  parallel: true
  commands:
    biome:
      glob: "*.{js,ts,cjs,mjs,d.cts,d.mts,jsx,tsx,json,jsonc}"
      run: bun run biome check --write --error-on-warnings --diagnostic-level=warn --no-errors-on-unmatched --files-ignore-unknown=true {staged_files}
      stage_fixed: true
    typecheck:
      run: bun run typecheck
    test:
      run: bun run test
    knip:
      run: bun run knip

# Hook-level files + command-level glob pattern:
# https://evilmartians.com/chronicles/5-cool-and-surprising-ways-to-configure-lefthook-for-automation-joy
post-merge:
  files: git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD
  commands:
    bun-install:
      glob: "bun.lock"
      run: bun install

post-checkout:
  files: git diff-tree -r --name-only --no-commit-id {1} {2}
  commands:
    bun-install:
      glob: "bun.lock"
      run: bun install

pre-push:
  commands:
    block-main:
      use_stdin: true
      run: |
        while read _ local_sha remote_ref remote_sha; do
          echo "$remote_ref" | grep -qE '^refs/heads/(main|master)$' || continue
          base=$([ "$remote_sha" = "0000000000000000000000000000000000000000" ] && echo "" || echo "$remote_sha..")
          changed_files=$(git diff --name-only "$base$local_sha" 2>/dev/null)
          [ -z "$changed_files" ] && continue
          non_beads=$(echo "$changed_files" | grep -v '^\.beads/' || true)
          [ -n "$non_beads" ] && {
            echo "Error: Direct push to main/master - only .beads/ changes allowed"
            echo "Non-.beads files changed:"
            echo "$non_beads"
            exit 1
          }
        done
        exit 0
    biome:
      glob: "*.{js,ts,cjs,mjs,d.cts,d.mts,jsx,tsx,json,jsonc}"
      run: bun run biome check --error-on-warnings --diagnostic-level=warn --no-errors-on-unmatched --files-ignore-unknown=true {push_files}
